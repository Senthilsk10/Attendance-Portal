{% extends 'base.html' %}

{% block content %}

        <div>
                    
                <H2>{{pool}}</H2>
            </div>
            <div>
                <h3>start time : {{pool.start_time}}, end time : {{pool.end_time}}</h3>
            </div>
            <div>
                <h3>
                    pool id : {{pool.id}}
                subject code : {{pool.subject.subject_code}}<br>
                subject name : {{pool.subject.subject_name}}<br>
                handled by : {{pool.subject.handling_staff.username}}<br>
                </h3>
            </div>
                <br>
                <br>
                <hr>
                <hr>
        </div>

        <button id="postButton">mark presence</button>

        <br><hr>
        <button id="refreshbtn">check access</button>
        <hr>
        <p id = "message"></p>


        <hr>
        <button id = "refresh-data">refresh</button>
        <table id = "attendance_result">
            <tr>
                <th>student name</th>
                <th>student rollno</th>
                <th>status</th>
                <th>timestamp</th>
            </tr>
            {% for data in result_data %}
            <tr>
                <td>{{data.user.username}}</td>
                <td>{{data.user.userid}}</td>
                <td>{{data.status}}</td>
                <td>{{data.timestamp}}</td>
            </tr>
            {% endfor %}
        </table>

        <hr>
        <form id="yourForm">
          <select id="requestType">
              <option value="leave">Leave</option>
              <option value="lateAttendance">Late Attendance</option>
          </select>
      
          <button type="button" id="submitButton">Submit</button>
      </form>
      
            
        <hr>


        <script>
          var headers = {
              'X-CSRFToken': getCSRFToken()
            };
            var pool_id = {{pool.id}};
        
        
          function makePostRequest() {
            $.ajax({
              type: 'POST',
              url: "{% url 'mark_presence' %}", // Replace with your URL pattern name
              data: { "pool_id": pool_id },
              headers: headers,
              success: function (response) {
                console.log('POST request successful', response);
                checkAccessAndUpdateMessages();
                // Handle the response here
              },
              error: function (error) {
                console.error('Error in POST request', error);
                // Handle the error here
              }
            });
          }
        
          // Function to check access and update messages
          function checkAccessAndUpdateMessages() {
            $.ajax({
              type: 'POST',
              url: "{% url 'check_access' %}", // Replace with your URL pattern name
              data: { "pool_id": pool_id },
              headers: headers,
              success: function (data) {
                console.log(data);
                // Check if "message" and "true" are present in the response
                if (data.roll_message === "true" && data.ip_message === "true") {
                  // If both conditions are true, show the Post button
                  $('#postButton').show();
                  document.getElementById('message').innerHTML = `
                    <strong>Roll Number Message:</strong> ${"You didn't mark your attendance yet"}<br>
                    <strong>IP Address Message:</strong> ${"Your device is allowed to make the present"}<br>
                    <strong>User IP:</strong> ${"Your IP address was obtained as: " + data.user_ip}
                  `;
                } else if (data.roll_message === "false" && data.ip_message === "true") {
                  // If Roll number condition is false, but IP condition is true
                  $('#postButton').hide();
                  document.getElementById('message').innerHTML = `
                    <strong>Roll Number Message:</strong> ${"You already marked your attendance"}<br>
                    <strong>IP Address Message:</strong> ${"Your device is allowed to make the present"}<br>
                    <strong>User IP:</strong> ${"Your IP address was obtained as: " + data.user_ip}
                  `;
                } else if (data.roll_message === "true" && data.ip_message === "false") {
                  // If Roll number condition is true, but IP condition is false
                  $('#postButton').hide();
                  document.getElementById('message').innerHTML = `
                    <strong>Roll Number Message:</strong> ${"You didn't mark your attendance yet"}<br>
                    <strong>IP Address Message:</strong> ${" but Your device is not allowed to make the present"}<br>
                    <strong>User IP:</strong> ${"Your IP address was obtained as: " + data.user_ip}
                  `;
                } else {
                  // If both conditions are false
                  $('#postButton').hide();
                  document.getElementById('message').innerHTML = `
                    <strong>Roll Number Message:</strong> ${"You already marked your attendance"}<br>
                    <strong>IP Address Message:</strong> ${"Your device is not allowed to make the present"}<br>
                    <strong>User IP:</strong> ${"Your IP address was obtained as: " + data.user_ip}
                  `;
                }
              },
              error: function (error) {
                console.error('Error in POST request', error);
                
              }
            });
          }
          
          checkAccessAndUpdateMessages();
          // Attach a click event to the button for checking access
          $(document).ready(function () {
            $('#refreshbtn').click(function () {
              checkAccessAndUpdateMessages();
            });
          });
        
          // Attach a click event to the Post button for making the POST request
          $(document).ready(function () {
            $('#postButton').click(function () {
              makePostRequest();
              
            });
          });

          function updateTable() {
            $.ajax({
              url: '{% url "GetTableData" %}',  // Change this to the actual URL
              type: 'POST',
              headers:headers,
              data:{"pk":pool_id},
              success: function (data) {
                // Update the table with new data
                $('#attendance_result tbody').html(data.html_content);
                console.log(data.html_content)
              }
            });
          }

          // Update the table on page load
          $(document).ready(function () {
            updateTable();
          });

          // Handle refresh button click
          $('#refresh-data').click(function () {
            updateTable();
          });

          var checkpointRequestUrl = "{% url 'checkpoint_request' pk=pool.id %}";

          function check_access_for_request() {
            $.ajax({
              
              url:checkpointRequestUrl,  
              type: 'POST',
              headers:headers,
              success: function (data) {
                console.log("message for request checking : " + data.message);
                if(data.message == "true"){
                  $('#yourForm').hide();
                }
              }
            });
          }

          $(document).ready(function () {
            check_access_for_request();
          });

          $(document).ready(function () {
            $("#submitButton").on("click", function () {
                var selectedRequestType = $("#requestType").val();
                var data = {
                    requestType: selectedRequestType
                };
                var url = "{% url 'save_request' pk=pool.id %}";
                $.ajax({
                    url: url,
                    type: "POST",
                    headers:headers,
                    data: data,
                    success: function (data) {
                        console.log("Request successful:", data.message);
                        check_access_for_request();
                    },
                    error: function (error) {
                        console.error("Error:", error);
                    }
                });
            });
        });

          
        </script>
        

{% endblock %}